<link rel="stylesheet" type="text/css" href="style.css">
<h3><a href="https://jaceklaskowski.gitbooks.io/mastering-spark-sql/spark-sql-functions-windows.html">Window functions</a></h3>

<div class="highlight"><pre><span></span><span class="k">import</span> <span class="nn">spark.implicits._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.functions._</span>
<span class="k">import</span> <span class="nn">org.apache.spark.sql.expressions.Window</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">import spark.implicits._</span>
<span class="go">import org.apache.spark.sql.functions._</span>
<span class="go">import org.apache.spark.sql.expressions.Window</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">case</span> <span class="k">class</span> <span class="nc">Salary</span><span class="o">(</span><span class="n">depName</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">empNo</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">salary</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">defined class Salary</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">empsalary</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;sales&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">5000</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;personnel&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3900</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;sales&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4800</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;sales&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">,</span> <span class="mi">4800</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;sales&quot;</span><span class="o">,</span> <span class="mi">6</span><span class="o">,</span> <span class="mi">4500</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;sales&quot;</span><span class="o">,</span> <span class="mi">12</span><span class="o">,</span> <span class="mi">5000</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;personnel&quot;</span><span class="o">,</span> <span class="mi">5</span><span class="o">,</span> <span class="mi">3500</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;develop&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">4200</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;develop&quot;</span><span class="o">,</span> <span class="mi">8</span><span class="o">,</span> <span class="mi">6000</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;develop&quot;</span><span class="o">,</span> <span class="mi">9</span><span class="o">,</span> <span class="mi">4500</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;develop&quot;</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">5200</span><span class="o">),</span>
  <span class="nc">Salary</span><span class="o">(</span><span class="s">&quot;develop&quot;</span><span class="o">,</span> <span class="mi">11</span><span class="o">,</span> <span class="mi">5200</span><span class="o">)).</span><span class="n">toDS</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">empsalary: org.apache.spark.sql.Dataset[Salary] = [depName: string, empNo: bigint ... 1 more field]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+</span>
<span class="go">|  depName|empNo|salary|</span>
<span class="go">+---------+-----+------+</span>
<span class="go">|    sales|    1|  5000|</span>
<span class="go">|personnel|    2|  3900|</span>
<span class="go">|    sales|    3|  4800|</span>
<span class="go">|    sales|    4|  4800|</span>
<span class="go">|    sales|    6|  4500|</span>
<span class="go">|    sales|   12|  5000|</span>
<span class="go">|personnel|    5|  3500|</span>
<span class="go">|  develop|    7|  4200|</span>
<span class="go">|  develop|    8|  6000|</span>
<span class="go">|  develop|    9|  4500|</span>
<span class="go">|  develop|   10|  5200|</span>
<span class="go">|  develop|   11|  5200|</span>
<span class="go">+---------+-----+------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">byDepName</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;depName&quot;</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">byDepName: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@75d89b5d</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;avg&quot;</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;salary&quot;</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byDepName</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+------+</span>
<span class="go">|  depName|empNo|salary|   avg|</span>
<span class="go">+---------+-----+------+------+</span>
<span class="go">|  develop|    7|  4200|5020.0|</span>
<span class="go">|  develop|    8|  6000|5020.0|</span>
<span class="go">|  develop|    9|  4500|5020.0|</span>
<span class="go">|  develop|   10|  5200|5020.0|</span>
<span class="go">|  develop|   11|  5200|5020.0|</span>
<span class="go">|    sales|    1|  5000|4820.0|</span>
<span class="go">|    sales|    3|  4800|4820.0|</span>
<span class="go">|    sales|    4|  4800|4820.0|</span>
<span class="go">|    sales|    6|  4500|4820.0|</span>
<span class="go">|    sales|   12|  5000|4820.0|</span>
<span class="go">|personnel|    2|  3900|3700.0|</span>
<span class="go">|personnel|    5|  3500|3700.0|</span>
<span class="go">+---------+-----+------+------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;avg&quot;</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">)</span> <span class="n">over</span> <span class="n">byDepName</span><span class="o">).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+------+</span>
<span class="go">|  depName|empNo|salary|   avg|</span>
<span class="go">+---------+-----+------+------+</span>
<span class="go">|  develop|    7|  4200|5020.0|</span>
<span class="go">|  develop|    8|  6000|5020.0|</span>
<span class="go">|  develop|    9|  4500|5020.0|</span>
<span class="go">|  develop|   10|  5200|5020.0|</span>
<span class="go">|  develop|   11|  5200|5020.0|</span>
<span class="go">|    sales|    1|  5000|4820.0|</span>
<span class="go">|    sales|    3|  4800|4820.0|</span>
<span class="go">|    sales|    4|  4800|4820.0|</span>
<span class="go">|    sales|    6|  4500|4820.0|</span>
<span class="go">|    sales|   12|  5000|4820.0|</span>
<span class="go">|personnel|    2|  3900|3700.0|</span>
<span class="go">|personnel|    5|  3500|3700.0|</span>
<span class="go">+---------+-----+------+------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">,</span> <span class=" -Symbol">&#39;empNo</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byDepName</span><span class="o">).</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;avg&quot;</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+</span>
<span class="go">|  depName|empNo|   avg|</span>
<span class="go">+---------+-----+------+</span>
<span class="go">|  develop|    7|5020.0|</span>
<span class="go">|  develop|    8|5020.0|</span>
<span class="go">|  develop|    9|5020.0|</span>
<span class="go">|  develop|   10|5020.0|</span>
<span class="go">|  develop|   11|5020.0|</span>
<span class="go">|    sales|    1|4820.0|</span>
<span class="go">|    sales|    3|4820.0|</span>
<span class="go">|    sales|    4|4820.0|</span>
<span class="go">|    sales|    6|4820.0|</span>
<span class="go">|    sales|   12|4820.0|</span>
<span class="go">|personnel|    2|3700.0|</span>
<span class="go">|personnel|    5|3700.0|</span>
<span class="go">+---------+-----+------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Orderby on the DF not window group</span>
<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;avg&quot;</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byDepName</span><span class="o">)).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+------+</span>
<span class="go">|  depName|empNo|salary|   avg|</span>
<span class="go">+---------+-----+------+------+</span>
<span class="go">|personnel|    5|  3500|3700.0|</span>
<span class="go">|personnel|    2|  3900|3700.0|</span>
<span class="go">|  develop|    7|  4200|5020.0|</span>
<span class="go">|  develop|    9|  4500|5020.0|</span>
<span class="go">|    sales|    6|  4500|4820.0|</span>
<span class="go">|    sales|    4|  4800|4820.0|</span>
<span class="go">|    sales|    3|  4800|4820.0|</span>
<span class="go">|    sales|    1|  5000|4820.0|</span>
<span class="go">|    sales|   12|  5000|4820.0|</span>
<span class="go">|  develop|   10|  5200|5020.0|</span>
<span class="go">|  develop|   11|  5200|5020.0|</span>
<span class="go">|  develop|    8|  6000|5020.0|</span>
<span class="go">+---------+-----+------+------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Ordering in window</span>

<span class="k">val</span> <span class="n">byDepNameSalaryDesc</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">.</span><span class="n">desc</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">byDepNameSalaryDesc: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@7da730b0</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;avg&quot;</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byDepNameSalaryDesc</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+-----------------+</span>
<span class="go">|  depName|empNo|salary|              avg|</span>
<span class="go">+---------+-----+------+-----------------+</span>
<span class="go">|  develop|    8|  6000|           6000.0|</span>
<span class="go">|  develop|   10|  5200|5466.666666666667|</span>
<span class="go">|  develop|   11|  5200|5466.666666666667|</span>
<span class="go">|  develop|    9|  4500|           5225.0|</span>
<span class="go">|  develop|    7|  4200|           5020.0|</span>
<span class="go">|    sales|    1|  5000|           5000.0|</span>
<span class="go">|    sales|   12|  5000|           5000.0|</span>
<span class="go">|    sales|    3|  4800|           4900.0|</span>
<span class="go">|    sales|    4|  4800|           4900.0|</span>
<span class="go">|    sales|    6|  4500|           4820.0|</span>
<span class="go">|personnel|    2|  3900|           3900.0|</span>
<span class="go">|personnel|    5|  3500|           3700.0|</span>
<span class="go">+---------+-----+------+-----------------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Rank (NOTE how the rank values are skipped)</span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;rank&quot;</span><span class="o">,</span> <span class="n">rank</span><span class="o">.</span><span class="n">over</span><span class="o">(</span><span class="n">byDepNameSalaryDesc</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary|rank|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    8|  6000|   1|</span>
<span class="go">|  develop|   10|  5200|   2|</span>
<span class="go">|  develop|   11|  5200|   2|</span>
<span class="go">|  develop|    9|  4500|   4|</span>
<span class="go">|  develop|    7|  4200|   5|</span>
<span class="go">|    sales|    1|  5000|   1|</span>
<span class="go">|    sales|   12|  5000|   1|</span>
<span class="go">|    sales|    3|  4800|   3|</span>
<span class="go">|    sales|    4|  4800|   3|</span>
<span class="go">|    sales|    6|  4500|   5|</span>
<span class="go">|personnel|    2|  3900|   1|</span>
<span class="go">|personnel|    5|  3500|   2|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// With dense_rank, rank values are not skipped</span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;rank&quot;</span><span class="o">,</span> <span class="n">dense_rank</span><span class="o">.</span><span class="n">over</span><span class="o">(</span><span class="n">byDepNameSalaryDesc</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary|rank|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    8|  6000|   1|</span>
<span class="go">|  develop|   10|  5200|   2|</span>
<span class="go">|  develop|   11|  5200|   2|</span>
<span class="go">|  develop|    9|  4500|   3|</span>
<span class="go">|  develop|    7|  4200|   4|</span>
<span class="go">|    sales|    1|  5000|   1|</span>
<span class="go">|    sales|   12|  5000|   1|</span>
<span class="go">|    sales|    3|  4800|   2|</span>
<span class="go">|    sales|    4|  4800|   2|</span>
<span class="go">|    sales|    6|  4500|   3|</span>
<span class="go">|personnel|    2|  3900|   1|</span>
<span class="go">|personnel|    5|  3500|   2|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<h3>Frame</h3>

<div class="highlight"><pre><span></span><span class="c1">// Max of salary, frame start = one row prior to current row, frame end = current row</span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">rowsBetween</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|4200|</span>
<span class="go">|  develop|    9|  4500|4500|</span>
<span class="go">|  develop|   10|  5200|5200|</span>
<span class="go">|  develop|   11|  5200|5200|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|    sales|    6|  4500|4500|</span>
<span class="go">|    sales|    3|  4800|4800|</span>
<span class="go">|    sales|    4|  4800|4800|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    5|  3500|3500|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Max of salary, frame start = one row prior to current row, frame end = one row following current row </span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">rowsBetween</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|4500|</span>
<span class="go">|  develop|    9|  4500|5200|</span>
<span class="go">|  develop|   10|  5200|5200|</span>
<span class="go">|  develop|   11|  5200|6000|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|    sales|    6|  4500|4800|</span>
<span class="go">|    sales|    3|  4800|4800|</span>
<span class="go">|    sales|    4|  4800|5000|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    5|  3500|3900|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Max of salary, frame start = all rows prior to current row, frame end = current row</span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|4200|</span>
<span class="go">|  develop|    9|  4500|4500|</span>
<span class="go">|  develop|   10|  5200|5200|</span>
<span class="go">|  develop|   11|  5200|5200|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|    sales|    6|  4500|4500|</span>
<span class="go">|    sales|    3|  4800|4800|</span>
<span class="go">|    sales|    4|  4800|4800|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    5|  3500|3500|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Max of salary, frame start = current row, frame end = all rows following current row </span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">unboundedFollowing</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|6000|</span>
<span class="go">|  develop|    9|  4500|6000|</span>
<span class="go">|  develop|   10|  5200|6000|</span>
<span class="go">|  develop|   11|  5200|6000|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|    sales|    6|  4500|5000|</span>
<span class="go">|    sales|    3|  4800|5000|</span>
<span class="go">|    sales|    4|  4800|5000|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    5|  3500|3900|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Max of salary, frame start = all rows prior to current row, frame end = all rows following current row </span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">rowsBetween</span><span class="o">(</span><span class="nc">Window</span><span class="o">.</span><span class="n">unboundedPreceding</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">unboundedFollowing</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|6000|</span>
<span class="go">|  develop|    9|  4500|6000|</span>
<span class="go">|  develop|   10|  5200|6000|</span>
<span class="go">|  develop|   11|  5200|6000|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|    sales|    6|  4500|5000|</span>
<span class="go">|    sales|    3|  4800|5000|</span>
<span class="go">|    sales|    4|  4800|5000|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    5|  3500|3900|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Same as above</span>

<span class="c1">// Max of salary, frame start = one row prior to current row, frame end = one row following current row </span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">.</span><span class="n">desc</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|  develop|   10|  5200|6000|</span>
<span class="go">|  develop|   11|  5200|6000|</span>
<span class="go">|  develop|    9|  4500|6000|</span>
<span class="go">|  develop|    7|  4200|6000|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|    sales|    3|  4800|5000|</span>
<span class="go">|    sales|    4|  4800|5000|</span>
<span class="go">|    sales|    6|  4500|5000|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">|personnel|    5|  3500|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<h4>Note: I don't understand the below behavior</h4>
<p><strong>Update</strong></p>
<ul>
<li>Frame or Window is determined by the field mentioned in orderBy()</li>
<li>Result (max in the below case) is determined by comparing the current row with the previous row</li>
<li>So, if you want to find max of salary withing a window order salary in desc order</li>
<li>if you want to find min of salary withing a window order salary in asc order</li>
</ul>

<div class="highlight"><pre><span></span><span class="c1">// NOTE: I don&#39;t understand this</span>

<span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">.</span><span class="n">asc</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|4200|</span>
<span class="go">|  develop|    9|  4500|4500|</span>
<span class="go">|  develop|   10|  5200|5200|</span>
<span class="go">|  develop|   11|  5200|5200|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|    sales|    6|  4500|4500|</span>
<span class="go">|    sales|    3|  4800|4800|</span>
<span class="go">|    sales|    4|  4800|4800|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    5|  3500|3500|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<h4>Looks like it compares the previous value to find the current result</h4>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;empNo</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|4200|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|  develop|    9|  4500|6000|</span>
<span class="go">|  develop|   10|  5200|6000|</span>
<span class="go">|  develop|   11|  5200|6000|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|    3|  4800|5000|</span>
<span class="go">|    sales|    4|  4800|5000|</span>
<span class="go">|    sales|    6|  4500|5000|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">|personnel|    5|  3500|3900|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<h4>frame is determined by the field mentioned in orderBy()</h4>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;salary</span><span class="o">).</span><span class="n">over</span><span class="o">(</span>
    <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;depName</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;empNo</span><span class="o">).</span><span class="n">rangeBetween</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">))).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----+</span>
<span class="go">|  depName|empNo|salary| max|</span>
<span class="go">+---------+-----+------+----+</span>
<span class="go">|  develop|    7|  4200|4200|</span>
<span class="go">|  develop|    8|  6000|6000|</span>
<span class="go">|  develop|    9|  4500|6000|</span>
<span class="go">|  develop|   10|  5200|5200|</span>
<span class="go">|  develop|   11|  5200|5200|</span>
<span class="go">|    sales|    1|  5000|5000|</span>
<span class="go">|    sales|    3|  4800|4800|</span>
<span class="go">|    sales|    4|  4800|4800|</span>
<span class="go">|    sales|    6|  4500|4500|</span>
<span class="go">|    sales|   12|  5000|5000|</span>
<span class="go">|personnel|    2|  3900|3900|</span>
<span class="go">|personnel|    5|  3500|3500|</span>
<span class="go">+---------+-----+------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">dataset</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="o">(</span><span class="s">&quot;Thin&quot;</span><span class="o">,</span>       <span class="s">&quot;cell phone&quot;</span><span class="o">,</span> <span class="mi">6000</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Normal&quot;</span><span class="o">,</span>     <span class="s">&quot;tablet&quot;</span><span class="o">,</span>     <span class="mi">1500</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Mini&quot;</span><span class="o">,</span>       <span class="s">&quot;tablet&quot;</span><span class="o">,</span>     <span class="mi">5500</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Ultra thin&quot;</span><span class="o">,</span> <span class="s">&quot;cell phone&quot;</span><span class="o">,</span> <span class="mi">5000</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Very thin&quot;</span><span class="o">,</span>  <span class="s">&quot;cell phone&quot;</span><span class="o">,</span> <span class="mi">6000</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Big&quot;</span><span class="o">,</span>        <span class="s">&quot;tablet&quot;</span><span class="o">,</span>     <span class="mi">2500</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Bendable&quot;</span><span class="o">,</span>   <span class="s">&quot;cell phone&quot;</span><span class="o">,</span> <span class="mi">3000</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Foldable&quot;</span><span class="o">,</span>   <span class="s">&quot;cell phone&quot;</span><span class="o">,</span> <span class="mi">3000</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Pro&quot;</span><span class="o">,</span>        <span class="s">&quot;tablet&quot;</span><span class="o">,</span>     <span class="mi">4500</span><span class="o">),</span>
  <span class="o">(</span><span class="s">&quot;Pro2&quot;</span><span class="o">,</span>       <span class="s">&quot;tablet&quot;</span><span class="o">,</span>     <span class="mi">6500</span><span class="o">))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;product&quot;</span><span class="o">,</span> <span class="s">&quot;category&quot;</span><span class="o">,</span> <span class="s">&quot;revenue&quot;</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">dataset: org.apache.spark.sql.DataFrame = [product: string, category: string ... 1 more field]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+</span>
<span class="go">|   product|  category|revenue|</span>
<span class="go">+----------+----------+-------+</span>
<span class="go">|      Thin|cell phone|   6000|</span>
<span class="go">|    Normal|    tablet|   1500|</span>
<span class="go">|      Mini|    tablet|   5500|</span>
<span class="go">|Ultra thin|cell phone|   5000|</span>
<span class="go">| Very thin|cell phone|   6000|</span>
<span class="go">|       Big|    tablet|   2500|</span>
<span class="go">|  Bendable|cell phone|   3000|</span>
<span class="go">|  Foldable|cell phone|   3000|</span>
<span class="go">|       Pro|    tablet|   4500|</span>
<span class="go">|      Pro2|    tablet|   6500|</span>
<span class="go">+----------+----------+-------+</span>
</pre></div>

<p>Find the best selling and 2nd best selling product in each category</p>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">byCategoryRevenueDesc</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;category</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;revenue</span><span class="o">.</span><span class="n">desc</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">byCategoryRevenueDesc: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@4462f528</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">ranked</span> <span class="k">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;dense_rank&quot;</span><span class="o">,</span> <span class="n">dense_rank</span><span class="o">.</span><span class="n">over</span><span class="o">(</span><span class="n">byCategoryRevenueDesc</span><span class="o">))</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">ranked: org.apache.spark.sql.DataFrame = [product: string, category: string ... 2 more fields]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">ranked</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+----------+</span>
<span class="go">|   product|  category|revenue|dense_rank|</span>
<span class="go">+----------+----------+-------+----------+</span>
<span class="go">|      Pro2|    tablet|   6500|         1|</span>
<span class="go">|      Mini|    tablet|   5500|         2|</span>
<span class="go">|       Pro|    tablet|   4500|         3|</span>
<span class="go">|       Big|    tablet|   2500|         4|</span>
<span class="go">|    Normal|    tablet|   1500|         5|</span>
<span class="go">|      Thin|cell phone|   6000|         1|</span>
<span class="go">| Very thin|cell phone|   6000|         1|</span>
<span class="go">|Ultra thin|cell phone|   5000|         2|</span>
<span class="go">|  Bendable|cell phone|   3000|         3|</span>
<span class="go">|  Foldable|cell phone|   3000|         3|</span>
<span class="go">+----------+----------+-------+----------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;percent_rank&quot;</span><span class="o">,</span> <span class="n">percent_rank</span><span class="o">.</span><span class="n">over</span><span class="o">(</span><span class="n">byCategoryRevenueDesc</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+------------+</span>
<span class="go">|   product|  category|revenue|percent_rank|</span>
<span class="go">+----------+----------+-------+------------+</span>
<span class="go">|      Pro2|    tablet|   6500|         0.0|</span>
<span class="go">|      Mini|    tablet|   5500|        0.25|</span>
<span class="go">|       Pro|    tablet|   4500|         0.5|</span>
<span class="go">|       Big|    tablet|   2500|        0.75|</span>
<span class="go">|    Normal|    tablet|   1500|         1.0|</span>
<span class="go">|      Thin|cell phone|   6000|         0.0|</span>
<span class="go">| Very thin|cell phone|   6000|         0.0|</span>
<span class="go">|Ultra thin|cell phone|   5000|         0.5|</span>
<span class="go">|  Bendable|cell phone|   3000|        0.75|</span>
<span class="go">|  Foldable|cell phone|   3000|        0.75|</span>
<span class="go">+----------+----------+-------+------------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">ranked</span><span class="o">.</span><span class="n">where</span><span class="o">(</span><span class=" -Symbol">&#39;rank</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+----+</span>
<span class="go">|   product|  category|revenue|rank|</span>
<span class="go">+----------+----------+-------+----+</span>
<span class="go">|      Pro2|    tablet|   6500|   1|</span>
<span class="go">|      Mini|    tablet|   5500|   2|</span>
<span class="go">|      Thin|cell phone|   6000|   1|</span>
<span class="go">| Very thin|cell phone|   6000|   1|</span>
<span class="go">|Ultra thin|cell phone|   5000|   2|</span>
<span class="go">+----------+----------+-------+----+</span>
</pre></div>

<p>Revenue difference per category</p>

<div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;max&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;revenue</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byCategoryRevenueDesc</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+----+</span>
<span class="go">|   product|  category|revenue| max|</span>
<span class="go">+----------+----------+-------+----+</span>
<span class="go">|      Pro2|    tablet|   6500|6500|</span>
<span class="go">|      Mini|    tablet|   5500|6500|</span>
<span class="go">|       Pro|    tablet|   4500|6500|</span>
<span class="go">|       Big|    tablet|   2500|6500|</span>
<span class="go">|    Normal|    tablet|   1500|6500|</span>
<span class="go">|      Thin|cell phone|   6000|6000|</span>
<span class="go">| Very thin|cell phone|   6000|6000|</span>
<span class="go">|Ultra thin|cell phone|   5000|6000|</span>
<span class="go">|  Bendable|cell phone|   3000|6000|</span>
<span class="go">|  Foldable|cell phone|   3000|6000|</span>
<span class="go">+----------+----------+-------+----+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">diffColumn</span> <span class="k">=</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;revenue</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byCategoryRevenueDesc</span><span class="o">)</span> <span class="o">-</span> <span class=" -Symbol">&#39;revenue</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">diffColumn: org.apache.spark.sql.Column = (max(revenue) OVER (PARTITION BY category ORDER BY revenue DESC NULLS LAST unspecifiedframe$()) - revenue)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">select</span><span class="o">(</span><span class="n">$</span><span class="s">&quot;*&quot;</span><span class="o">,</span> <span class="n">diffColumn</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="s">&quot;revenue_diff&quot;</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+------------+</span>
<span class="go">|   product|  category|revenue|revenue_diff|</span>
<span class="go">+----------+----------+-------+------------+</span>
<span class="go">|      Pro2|    tablet|   6500|           0|</span>
<span class="go">|      Mini|    tablet|   5500|        1000|</span>
<span class="go">|       Pro|    tablet|   4500|        2000|</span>
<span class="go">|       Big|    tablet|   2500|        4000|</span>
<span class="go">|    Normal|    tablet|   1500|        5000|</span>
<span class="go">|      Thin|cell phone|   6000|           0|</span>
<span class="go">| Very thin|cell phone|   6000|           0|</span>
<span class="go">|Ultra thin|cell phone|   5000|        1000|</span>
<span class="go">|  Bendable|cell phone|   3000|        3000|</span>
<span class="go">|  Foldable|cell phone|   3000|        3000|</span>
<span class="go">+----------+----------+-------+------------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">dataset</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;revenue_diff&quot;</span><span class="o">,</span> <span class="n">diffColumn</span><span class="o">).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----------+-------+------------+</span>
<span class="go">|   product|  category|revenue|revenue_diff|</span>
<span class="go">+----------+----------+-------+------------+</span>
<span class="go">|      Pro2|    tablet|   6500|           0|</span>
<span class="go">|      Mini|    tablet|   5500|        1000|</span>
<span class="go">|       Pro|    tablet|   4500|        2000|</span>
<span class="go">|       Big|    tablet|   2500|        4000|</span>
<span class="go">|    Normal|    tablet|   1500|        5000|</span>
<span class="go">|      Thin|cell phone|   6000|           0|</span>
<span class="go">| Very thin|cell phone|   6000|           0|</span>
<span class="go">|Ultra thin|cell phone|   5000|        1000|</span>
<span class="go">|  Bendable|cell phone|   3000|        3000|</span>
<span class="go">|  Foldable|cell phone|   3000|        3000|</span>
<span class="go">+----------+----------+-------+------------+</span>
</pre></div>

<h4>lead</h4>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">pairs</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">x</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">5</span>
    <span class="n">y</span> <span class="k">&lt;-</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">2</span>
<span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">)</span>

<span class="k">val</span> <span class="n">ds</span> <span class="k">=</span> <span class="n">pairs</span><span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;ns&quot;</span><span class="o">,</span> <span class="s">&quot;tens&quot;</span><span class="o">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---+----+</span>
<span class="go">| ns|tens|</span>
<span class="go">+---+----+</span>
<span class="go">|  1|  10|</span>
<span class="go">|  1|  20|</span>
<span class="go">|  2|  20|</span>
<span class="go">|  2|  40|</span>
<span class="go">|  3|  30|</span>
<span class="go">|  3|  60|</span>
<span class="go">|  4|  40|</span>
<span class="go">|  4|  80|</span>
<span class="go">|  5|  50|</span>
<span class="go">|  5| 100|</span>
<span class="go">+---+----+</span>

<span class="go">pairs: scala.collection.immutable.IndexedSeq[(Int, Int)] = Vector((1,10), (1,20), (2,20), (2,40), (3,30), (3,60), (4,40), (4,80), (5,50), (5,100))</span>
<span class="go">ds: org.apache.spark.sql.DataFrame = [ns: int, tens: int]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">overNs</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;ns</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;tens</span><span class="o">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;lead&quot;</span><span class="o">,</span> <span class="n">lead</span><span class="o">(</span><span class=" -Symbol">&#39;tens</span><span class="o">,</span> <span class="mi">1</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">overNs</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---+----+----+</span>
<span class="go">| ns|tens|lead|</span>
<span class="go">+---+----+----+</span>
<span class="go">|  1|  10|  20|</span>
<span class="go">|  1|  20|null|</span>
<span class="go">|  3|  30|  60|</span>
<span class="go">|  3|  60|null|</span>
<span class="go">|  5|  50| 100|</span>
<span class="go">|  5| 100|null|</span>
<span class="go">|  4|  40|  80|</span>
<span class="go">|  4|  80|null|</span>
<span class="go">|  2|  20|  40|</span>
<span class="go">|  2|  40|null|</span>
<span class="go">+---+----+----+</span>

<span class="go">overNs: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@5f5b22e9</span>
</pre></div>

<h4>Running total</h4>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">sales</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
  <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">5</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">3</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">4</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">8</span><span class="o">),</span>
  <span class="o">(</span><span class="mi">5</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">8</span><span class="o">))</span>
  <span class="o">.</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="s">&quot;orderID&quot;</span><span class="o">,</span> <span class="s">&quot;prodID&quot;</span><span class="o">,</span> <span class="s">&quot;orderQty&quot;</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">sales: org.apache.spark.sql.DataFrame = [id: int, orderID: int ... 2 more fields]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">sales</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---+-------+------+--------+</span>
<span class="go">| id|orderID|prodID|orderQty|</span>
<span class="go">+---+-------+------+--------+</span>
<span class="go">|  0|      0|     0|       5|</span>
<span class="go">|  1|      0|     1|       3|</span>
<span class="go">|  2|      0|     2|       1|</span>
<span class="go">|  3|      1|     0|       2|</span>
<span class="go">|  4|      2|     0|       8|</span>
<span class="go">|  5|      2|     2|       8|</span>
<span class="go">+---+-------+------+--------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">byId</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;id</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">byId: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@3bc13d2f</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">sales</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;running_total&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class=" -Symbol">&#39;orderQty</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byId</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---+-------+------+--------+-------------+</span>
<span class="go">| id|orderID|prodID|orderQty|running_total|</span>
<span class="go">+---+-------+------+--------+-------------+</span>
<span class="go">|  0|      0|     0|       5|            5|</span>
<span class="go">|  1|      0|     1|       3|            8|</span>
<span class="go">|  2|      0|     2|       1|            9|</span>
<span class="go">|  3|      1|     0|       2|           11|</span>
<span class="go">|  4|      2|     0|       8|           19|</span>
<span class="go">|  5|      2|     2|       8|           27|</span>
<span class="go">+---+-------+------+--------+-------------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">byOrderId</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;orderID</span><span class="o">)</span>
<span class="n">sales</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;running_total_per_order&quot;</span><span class="o">,</span> <span class="n">sum</span><span class="o">(</span><span class=" -Symbol">&#39;orderQty</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">byOrderId</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---+-------+------+--------+-----------------------+</span>
<span class="go">| id|orderID|prodID|orderQty|running_total_per_order|</span>
<span class="go">+---+-------+------+--------+-----------------------+</span>
<span class="go">|  3|      1|     0|       2|                      2|</span>
<span class="go">|  4|      2|     0|       8|                     16|</span>
<span class="go">|  5|      2|     2|       8|                     16|</span>
<span class="go">|  0|      0|     0|       5|                      9|</span>
<span class="go">|  1|      0|     1|       3|                      9|</span>
<span class="go">|  2|      0|     2|       1|                      9|</span>
<span class="go">+---+-------+------+--------+-----------------------+</span>

<span class="go">byOrderId: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@647a9e69</span>
</pre></div>

<h4>row_number : Sequential number within window partition</h4>

<div class="highlight"><pre><span></span><span class="n">empsalary</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;row_number&quot;</span><span class="o">,</span> <span class="n">row_number</span><span class="o">.</span><span class="n">over</span><span class="o">(</span><span class="n">byDepNameSalaryDesc</span><span class="o">)).</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+---------+-----+------+----------+</span>
<span class="go">|  depName|empNo|salary|row_number|</span>
<span class="go">+---------+-----+------+----------+</span>
<span class="go">|  develop|    8|  6000|         1|</span>
<span class="go">|  develop|   10|  5200|         2|</span>
<span class="go">|  develop|   11|  5200|         3|</span>
<span class="go">|  develop|    9|  4500|         4|</span>
<span class="go">|  develop|    7|  4200|         5|</span>
<span class="go">|    sales|    1|  5000|         1|</span>
<span class="go">|    sales|   12|  5000|         2|</span>
<span class="go">|    sales|    3|  4800|         3|</span>
<span class="go">|    sales|    4|  4800|         4|</span>
<span class="go">|    sales|    6|  4500|         5|</span>
<span class="go">|personnel|    2|  3900|         1|</span>
<span class="go">|personnel|    5|  3500|         2|</span>
<span class="go">+---------+-----+------+----------+</span>
</pre></div>

<h3><a href="https://deannaschneider.wordpress.com/2018/11/05/window-functions-in-scala/">Another example</a></h3>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">testDF</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
<span class="o">(</span><span class="mi">1525567980</span><span class="o">,</span><span class="mf">28.9</span><span class="o">,</span> <span class="s">&quot;Ashland&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525569900</span><span class="o">,</span><span class="mf">28.4</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525571580</span><span class="o">,</span><span class="mf">28.9</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525575120</span><span class="o">,</span><span class="mf">28.9</span><span class="o">,</span> <span class="s">&quot;Ashland&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525578780</span><span class="o">,</span><span class="mf">28.0</span><span class="o">,</span> <span class="s">&quot;Ashland&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525582320</span><span class="o">,</span><span class="mf">28.0</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525585980</span><span class="o">,</span><span class="mf">28.0</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525589580</span><span class="o">,</span><span class="mf">28.0</span><span class="o">,</span> <span class="s">&quot;Ashland&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525591440</span><span class="o">,</span><span class="mf">28.4</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525593180</span><span class="o">,</span><span class="mf">28.0</span><span class="o">,</span> <span class="s">&quot;Ashland&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525596780</span><span class="o">,</span><span class="mf">28.0</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">),</span>
<span class="o">(</span><span class="mi">1525600380</span><span class="o">,</span><span class="mf">28.9</span><span class="o">,</span> <span class="s">&quot;Bayfield&quot;</span><span class="o">)</span>
<span class="o">).</span><span class="n">toDF</span><span class="o">(</span><span class="s">&quot;uxt&quot;</span><span class="o">,</span> <span class="s">&quot;Temp&quot;</span><span class="o">,</span> <span class="s">&quot;City&quot;</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">testDF: org.apache.spark.sql.DataFrame = [uxt: int, Temp: double ... 1 more field]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">testDF</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----+--------+</span>
<span class="go">|       uxt|Temp|    City|</span>
<span class="go">+----------+----+--------+</span>
<span class="go">|1525567980|28.9| Ashland|</span>
<span class="go">|1525569900|28.4|Bayfield|</span>
<span class="go">|1525571580|28.9|Bayfield|</span>
<span class="go">|1525575120|28.9| Ashland|</span>
<span class="go">|1525578780|28.0| Ashland|</span>
<span class="go">|1525582320|28.0|Bayfield|</span>
<span class="go">|1525585980|28.0|Bayfield|</span>
<span class="go">|1525589580|28.0| Ashland|</span>
<span class="go">|1525591440|28.4|Bayfield|</span>
<span class="go">|1525593180|28.0| Ashland|</span>
<span class="go">|1525596780|28.0|Bayfield|</span>
<span class="go">|1525600380|28.9|Bayfield|</span>
<span class="go">+----------+----+--------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">testWithDates</span> <span class="k">=</span> <span class="n">testDF</span><span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;Date&quot;</span><span class="o">,</span> <span class="n">to_timestamp</span><span class="o">(</span><span class="n">from_unixtime</span><span class="o">(</span><span class=" -Symbol">&#39;uxt</span><span class="o">)))</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">testWithDates: org.apache.spark.sql.DataFrame = [uxt: int, Temp: double ... 2 more fields]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">testWithDates</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----+--------+-------------------+</span>
<span class="go">|       uxt|Temp|    City|               Date|</span>
<span class="go">+----------+----+--------+-------------------+</span>
<span class="go">|1525567980|28.9| Ashland|2018-05-06 10:53:00|</span>
<span class="go">|1525569900|28.4|Bayfield|2018-05-06 11:25:00|</span>
<span class="go">|1525571580|28.9|Bayfield|2018-05-06 11:53:00|</span>
<span class="go">|1525575120|28.9| Ashland|2018-05-06 12:52:00|</span>
<span class="go">|1525578780|28.0| Ashland|2018-05-06 13:53:00|</span>
<span class="go">|1525582320|28.0|Bayfield|2018-05-06 14:52:00|</span>
<span class="go">|1525585980|28.0|Bayfield|2018-05-06 15:53:00|</span>
<span class="go">|1525589580|28.0| Ashland|2018-05-06 16:53:00|</span>
<span class="go">|1525591440|28.4|Bayfield|2018-05-06 17:24:00|</span>
<span class="go">|1525593180|28.0| Ashland|2018-05-06 17:53:00|</span>
<span class="go">|1525596780|28.0|Bayfield|2018-05-06 18:53:00|</span>
<span class="go">|1525600380|28.9|Bayfield|2018-05-06 19:53:00|</span>
<span class="go">+----------+----+--------+-------------------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// Create a window or frame of 1 hr (3600 secs) prior to each row</span>

<span class="k">val</span> <span class="n">oneHrPriorFrame</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;uxt</span><span class="o">).</span><span class="n">rangeBetween</span><span class="o">(-</span><span class="mi">3600</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">oneHrPriorFrame: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@4da5a054</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">byRange</span> <span class="k">=</span> <span class="n">testWithDates</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;avgTemp&quot;</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">oneHrPriorFrame</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;minTemp&quot;</span><span class="o">,</span> <span class="n">min</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">oneHrPriorFrame</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;maxTemp&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">oneHrPriorFrame</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;rowCount&quot;</span><span class="o">,</span> <span class="n">count</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">oneHrPriorFrame</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;frameStart&quot;</span><span class="o">,</span> <span class=" -Symbol">&#39;uxt</span> <span class="o">-</span> <span class="mi">3600</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;startDate&quot;</span><span class="o">,</span> <span class="n">to_timestamp</span><span class="o">(</span><span class=" -Symbol">&#39;frameStart</span><span class="o">))</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">byRange: org.apache.spark.sql.DataFrame = [uxt: int, Temp: double ... 8 more fields]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">byRange</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----+--------+-------------------+------------------+-------+-------+--------+----------+-------------------+</span>
<span class="go">|       uxt|Temp|    City|               Date|           avgTemp|minTemp|maxTemp|rowCount|frameStart|          startDate|</span>
<span class="go">+----------+----+--------+-------------------+------------------+-------+-------+--------+----------+-------------------+</span>
<span class="go">|1525567980|28.9| Ashland|2018-05-06 10:53:00|              28.9|   28.9|   28.9|       1|1525564380|2018-05-06 09:53:00|</span>
<span class="go">|1525569900|28.4|Bayfield|2018-05-06 11:25:00|             28.65|   28.4|   28.9|       2|1525566300|2018-05-06 10:25:00|</span>
<span class="go">|1525571580|28.9|Bayfield|2018-05-06 11:53:00| 28.73333333333333|   28.4|   28.9|       3|1525567980|2018-05-06 10:53:00|</span>
<span class="go">|1525575120|28.9| Ashland|2018-05-06 12:52:00|              28.9|   28.9|   28.9|       2|1525571520|2018-05-06 11:52:00|</span>
<span class="go">|1525578780|28.0| Ashland|2018-05-06 13:53:00|              28.0|   28.0|   28.0|       1|1525575180|2018-05-06 12:53:00|</span>
<span class="go">|1525582320|28.0|Bayfield|2018-05-06 14:52:00|              28.0|   28.0|   28.0|       2|1525578720|2018-05-06 13:52:00|</span>
<span class="go">|1525585980|28.0|Bayfield|2018-05-06 15:53:00|              28.0|   28.0|   28.0|       1|1525582380|2018-05-06 14:53:00|</span>
<span class="go">|1525589580|28.0| Ashland|2018-05-06 16:53:00|              28.0|   28.0|   28.0|       2|1525585980|2018-05-06 15:53:00|</span>
<span class="go">|1525591440|28.4|Bayfield|2018-05-06 17:24:00|              28.2|   28.0|   28.4|       2|1525587840|2018-05-06 16:24:00|</span>
<span class="go">|1525593180|28.0| Ashland|2018-05-06 17:53:00|28.133333333333336|   28.0|   28.4|       3|1525589580|2018-05-06 16:53:00|</span>
<span class="go">|1525596780|28.0|Bayfield|2018-05-06 18:53:00|              28.0|   28.0|   28.0|       2|1525593180|2018-05-06 17:53:00|</span>
<span class="go">|1525600380|28.9|Bayfield|2018-05-06 19:53:00|             28.45|   28.0|   28.9|       2|1525596780|2018-05-06 18:53:00|</span>
<span class="go">+----------+----+--------+-------------------+------------------+-------+-------+--------+----------+-------------------+</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="c1">// 2 hr window per city</span>

<span class="k">val</span> <span class="n">twoHrWindowByCity</span> <span class="k">=</span> <span class="nc">Window</span><span class="o">.</span><span class="n">partitionBy</span><span class="o">(</span><span class=" -Symbol">&#39;City</span><span class="o">).</span><span class="n">orderBy</span><span class="o">(</span><span class=" -Symbol">&#39;uxt</span><span class="o">).</span><span class="n">rangeBetween</span><span class="o">(-</span><span class="mi">7200</span><span class="o">,</span> <span class="nc">Window</span><span class="o">.</span><span class="n">currentRow</span><span class="o">)</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">twoHrWindowByCity: org.apache.spark.sql.expressions.WindowSpec = org.apache.spark.sql.expressions.WindowSpec@7a5d5e82</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="k">val</span> <span class="n">byCity</span> <span class="k">=</span> <span class="n">testWithDates</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;avgTemp&quot;</span><span class="o">,</span> <span class="n">avg</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">twoHrWindowByCity</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;minTemp&quot;</span><span class="o">,</span> <span class="n">min</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">twoHrWindowByCity</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;maxTemp&quot;</span><span class="o">,</span> <span class="n">max</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">twoHrWindowByCity</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;rowCount&quot;</span><span class="o">,</span> <span class="n">count</span><span class="o">(</span><span class=" -Symbol">&#39;Temp</span><span class="o">).</span><span class="n">over</span><span class="o">(</span><span class="n">twoHrWindowByCity</span><span class="o">))</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;frameStart&quot;</span><span class="o">,</span> <span class=" -Symbol">&#39;uxt</span> <span class="o">-</span> <span class="mi">3600</span><span class="o">)</span>
    <span class="o">.</span><span class="n">withColumn</span><span class="o">(</span><span class="s">&quot;startDate&quot;</span><span class="o">,</span> <span class="n">to_timestamp</span><span class="o">(</span><span class=" -Symbol">&#39;frameStart</span><span class="o">))</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">byCity: org.apache.spark.sql.DataFrame = [uxt: int, Temp: double ... 8 more fields]</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="n">byCity</span><span class="o">.</span><span class="n">show</span>
</pre></div>

<div class="highlight"><pre><span></span><span class="go">+----------+----+--------+-------------------+-------+-------+-------+--------+----------+-------------------+</span>
<span class="go">|       uxt|Temp|    City|               Date|avgTemp|minTemp|maxTemp|rowCount|frameStart|          startDate|</span>
<span class="go">+----------+----+--------+-------------------+-------+-------+-------+--------+----------+-------------------+</span>
<span class="go">|1525567980|28.9| Ashland|2018-05-06 10:53:00|   28.9|   28.9|   28.9|       1|1525564380|2018-05-06 09:53:00|</span>
<span class="go">|1525575120|28.9| Ashland|2018-05-06 12:52:00|   28.9|   28.9|   28.9|       2|1525571520|2018-05-06 11:52:00|</span>
<span class="go">|1525578780|28.0| Ashland|2018-05-06 13:53:00|  28.45|   28.0|   28.9|       2|1525575180|2018-05-06 12:53:00|</span>
<span class="go">|1525589580|28.0| Ashland|2018-05-06 16:53:00|   28.0|   28.0|   28.0|       1|1525585980|2018-05-06 15:53:00|</span>
<span class="go">|1525593180|28.0| Ashland|2018-05-06 17:53:00|   28.0|   28.0|   28.0|       2|1525589580|2018-05-06 16:53:00|</span>
<span class="go">|1525569900|28.4|Bayfield|2018-05-06 11:25:00|   28.4|   28.4|   28.4|       1|1525566300|2018-05-06 10:25:00|</span>
<span class="go">|1525571580|28.9|Bayfield|2018-05-06 11:53:00|  28.65|   28.4|   28.9|       2|1525567980|2018-05-06 10:53:00|</span>
<span class="go">|1525582320|28.0|Bayfield|2018-05-06 14:52:00|   28.0|   28.0|   28.0|       1|1525578720|2018-05-06 13:52:00|</span>
<span class="go">|1525585980|28.0|Bayfield|2018-05-06 15:53:00|   28.0|   28.0|   28.0|       2|1525582380|2018-05-06 14:53:00|</span>
<span class="go">|1525591440|28.4|Bayfield|2018-05-06 17:24:00|   28.2|   28.0|   28.4|       2|1525587840|2018-05-06 16:24:00|</span>
<span class="go">|1525596780|28.0|Bayfield|2018-05-06 18:53:00|   28.2|   28.0|   28.4|       2|1525593180|2018-05-06 17:53:00|</span>
<span class="go">|1525600380|28.9|Bayfield|2018-05-06 19:53:00|  28.45|   28.0|   28.9|       2|1525596780|2018-05-06 18:53:00|</span>
<span class="go">+----------+----+--------+-------------------+-------+-------+-------+--------+----------+-------------------+</span>
</pre></div>
